# RAG & Milvus ê°„ë‹¨ ì •ë¦¬

RAG 
- ë°ì´í„° indexing ì²´ê³„ê°€ ë” ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°ë¨.
- pre-retrieval, retrieval-time, post-retrieval ê²€ì‚¬ê°€ ì „ë¶€ ì´ë£¨ì–´ì§.

Faiss Index
- ANN ê¸°ë°˜
- IndexHNSWFlat : ë¹Œë“œ O(NlogN) ë°±ë§Œê°œì— ìˆ˜ì´ˆ. ì„œì¹˜ O(logN) ë°±ë§Œê°œ ë¬¸ì„œ ê¸°ì¤€ ë°€ë¦¬ì´ˆ.
- Hierarchical Navigable Small World
- ê³„ì¸µì  ê·¸ë˜í”„ë¥¼ ê·¸ë¦¬ê³  ìµœë‹¨ ê±°ë¦¬ ê¸°ë°˜ìœ¼ë¡œ íƒìƒ‰. ê³„ì¸µì„ íƒ€ê³  ëª©í‘œ ì§€ì  ê·¼ì²˜ë¡œ ë¹ ë¥´ê²Œ ê°„ í›„, ì •ë°€ íƒìƒ‰í•˜ëŠ” ë°©ì‹.

Milvus
- faiss ë¥¼ í•µì‹¬ìœ¼ë¡œ í•˜ëŠ” ë²¡í„°DB - DBì˜ í…Œì´ë¸” ì—­í• .
- Milvusì—ì„œ ë²¡í„°ë¥¼ ì €ì¥í•˜ëŠ” ë…¼ë¦¬ì  ë‹¨ìœ„ : "ì»¬ë ‰ì…˜"
- ANN êµ¬ì¡°ë¥¼ í™œìš©í•´ì„œ ë²¡í„°ë¥¼ ì €ì¥
- Faiss/ milvus ëª¨ë‘ ë³‘ë ¬ ì²˜ë¦¬ í™˜ê²½ì— ìµœì í™” ë˜ì–´ ìˆìŒ.

Milvus êµ¬ì¶•ì˜ˆì‹œ : í…Œì´ë¸” ì—­í• ì„ í•˜ëŠ” ì»¬ë ‰ì…˜ ìƒì„±.
```
from pymilvus import connections, utility, Collection, FieldSchema, CollectionSchema, DataType
import numpy as np

# 1. Milvus ì„œë²„ ì—°ê²° ì„¤ì •
# ë¡œì»¬ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ Milvus ì„œë²„ì— ì—°ê²°í•©ë‹ˆë‹¤. (ê¸°ë³¸ í¬íŠ¸: 19530)
# Milvus ì„œë²„ê°€ ë‹¤ë¥¸ ê³³ì— ìˆë‹¤ë©´ ì£¼ì†Œë¥¼ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.
try:
    connections.connect(alias="default", host="localhost", port="19530")
    print("âœ… Milvus ì„œë²„ ì—°ê²° ì„±ê³µ.")
except Exception as e:
    print(f"âŒ Milvus ì„œë²„ ì—°ê²° ì‹¤íŒ¨: {e}. ì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.")
    exit()

COLLECTION_NAME = "rag_document_chunks"
DIMENSION = 128  # ë²¡í„° ì°¨ì› (ì˜ˆ: ì„ë² ë”© ëª¨ë¸ì˜ ì¶œë ¥ ì°¨ì›)

# ì»¬ë ‰ì…˜ì´ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì‚­ì œí•©ë‹ˆë‹¤.
if utility.has_collection(COLLECTION_NAME):
    utility.drop_collection(COLLECTION_NAME)
    print(f"ê¸°ì¡´ ì»¬ë ‰ì…˜ '{COLLECTION_NAME}' ì‚­ì œ ì™„ë£Œ.")

# 2. ì»¬ë ‰ì…˜ ìŠ¤í‚¤ë§ˆ ì •ì˜ (ë°ì´í„° êµ¬ì¡° ì •ì˜)
# MilvusëŠ” ë²¡í„° ì™¸ì— ë©”íƒ€ë°ì´í„°ë„ ì €ì¥í•´ì•¼ í•©ë‹ˆë‹¤.

fields = [
    # í•„ë“œ 1: primary key (ê³ ìœ  ID)
    FieldSchema(name="id", dtype=DataType.INT64, is_primary=True, auto_id=True, description="Primary ID"),
    
    # í•„ë“œ 2: RAGì˜ ì›ë³¸ í…ìŠ¤íŠ¸ ì²­í¬ë¥¼ ì‹ë³„í•˜ëŠ” ID (ë©”íƒ€ë°ì´í„°)
    FieldSchema(name="chunk_id", dtype=DataType.VARCHAR, max_length=256, description="Original Chunk ID"),
    
    # í•„ë“œ 3: ë²¡í„° í•„ë“œ (ê°€ì¥ ì¤‘ìš”)
    FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=DIMENSION, description="Vector embedding")
]

schema = CollectionSchema(fields, description="RAG Document Chunks Collection")

# 3. ì»¬ë ‰ì…˜ ìƒì„±
collection = Collection(name=COLLECTION_NAME, schema=schema)
print(f"ğŸ“¦ ì»¬ë ‰ì…˜ '{COLLECTION_NAME}' ìƒì„± ì™„ë£Œ.")
```

Milvus ë°ì´í„° ì‚½ì…: ë²¡í„° insert -> index êµ¬ì¶• ìˆœì„œë¡œ ì§„í–‰ë¨.
```
# --- 4. ë°ì´í„° ì¤€ë¹„ (RAG ì„ë² ë”© ì‹œë®¬ë ˆì´ì…˜) ---
num_entities = 1000  # ì‚½ì…í•  ë²¡í„°ì˜ ìˆ˜
rng = np.random.default_rng(1234)

# 128ì°¨ì›ì˜ ëœë¤ ë²¡í„° 1000ê°œ ìƒì„±
data = [rng.random((DIMENSION,)).astype('float32') for _ in range(num_entities)]
# ë©”íƒ€ë°ì´í„° (RAGì—ì„œ ì‹¤ì œ í…ìŠ¤íŠ¸ ì²­í¬ì™€ ì—°ê²°ë  ID)
chunk_ids = [f"chunk_{i}" for i in range(num_entities)]

# ë°ì´í„° êµ¬ì¡°í™” (Milvus ì‚½ì… í˜•ì‹)
entities = [
    chunk_ids,
    data
]

# --- 5. ë°ì´í„° ì‚½ì… ---
insert_result = collection.insert(entities)
print(f"ğŸ“¥ {len(insert_result.primary_keys)}ê°œì˜ ì—”í‹°í‹° ì‚½ì… ì™„ë£Œ.")

# --- 6. ì¸ë±ìŠ¤ êµ¬ì¶• (í•µì‹¬ RAG ë‹¨ê³„) ---
# Milvusì—ê²Œ Faissì˜ HNSW ì•Œê³ ë¦¬ì¦˜ì„ ì‚¬ìš©í•˜ì—¬ ì¸ë±ìŠ¤ë¥¼ ë§Œë“¤ë„ë¡ ì§€ì‹œí•©ë‹ˆë‹¤.
# ì´ ì¸ë±ìŠ¤ëŠ” ì‹¤ì œë¡œ Milvus ë‚´ì—ì„œ Faiss ì—”ì§„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
index_params = {
    "index_type": "HNSW",
    "metric_type": "L2",  # ìœ í´ë¦¬ë“œ ê±°ë¦¬ (L2) ì‚¬ìš©
    "params": {"M": 16, "efConstruction": 200} # HNSW í•˜ì´í¼íŒŒë¼ë¯¸í„°
}

collection.create_index("embedding", index_params)
print("âš™ï¸ ì¸ë±ìŠ¤ HNSW êµ¬ì¶• ì™„ë£Œ.")

# ë°ì´í„°ë¥¼ ê²€ìƒ‰ì— ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë©”ëª¨ë¦¬ì— ë¡œë“œí•©ë‹ˆë‹¤.
collection.load() 
print("ë©”ëª¨ë¦¬ ë¡œë“œ ì™„ë£Œ.")
```

ë²¡í„° ê²€ìƒ‰:
```
# --- 7. ì§ˆì˜ ë²¡í„° ì¤€ë¹„ (ì‚¬ìš©ì ì§ˆë¬¸ ì„ë² ë”© ì‹œë®¬ë ˆì´ì…˜) ---
# ë‹¨ì¼ ì§ˆì˜ ë²¡í„° ìƒì„±
query_vector = rng.random((1, DIMENSION)).astype('float32')

# --- 8. ê²€ìƒ‰ ìˆ˜í–‰ ---
TOP_K = 5 # ê°€ì¥ ê°€ê¹Œìš´ 5ê°œ ë²¡í„°ë¥¼ ê²€ìƒ‰

search_params = {
    "metric_type": "L2",
    "params": {"ef": 50} # HNSW ê²€ìƒ‰ ë§¤ê°œë³€ìˆ˜ (efSearchì™€ ìœ ì‚¬)
}

start_time = time.time()
results = collection.search(
    data=query_vector,       # ê²€ìƒ‰í•  ì§ˆì˜ ë²¡í„°
    anns_field="embedding",  # ê²€ìƒ‰ì„ ìˆ˜í–‰í•  í•„ë“œ (ë²¡í„° í•„ë“œ)
    param=search_params,     # ê²€ìƒ‰ ë§¤ê°œë³€ìˆ˜
    limit=TOP_K,             # Top-K
    output_fields=["chunk_id"] # ê²°ê³¼ë¡œ ë°˜í™˜ë°›ì„ ë©”íƒ€ë°ì´í„° í•„ë“œ
)
end_time = time.time()

print(f"\nğŸ” ê²€ìƒ‰ ì™„ë£Œ. (ì†Œìš” ì‹œê°„: {end_time - start_time:.4f}ì´ˆ)")

# --- 9. ê²°ê³¼ ì¶œë ¥ ---
print(f"\nâœ… ê²€ìƒ‰ ê²°ê³¼ (Top-{TOP_K}):")
for hit in results[0]:
    # hit.idëŠ” Milvusì˜ ë‚´ë¶€ ID, hit.entity.get('chunk_id')ëŠ” ë©”íƒ€ë°ì´í„°
    print(f"  - Chunk ID: {hit.entity.get('chunk_id')}, ìœ ì‚¬ë„(ê±°ë¦¬): {hit.distance:.4f}")

# ì‘ì—… í›„ ì—°ê²° ì¢…ë£Œ
connections.disconnect("default")
```